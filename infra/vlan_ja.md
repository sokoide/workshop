# Podman å®Ÿç¿’ï¼šmacvlan ã¨ Linux ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ä½œã‚‹ L3 åˆ†é›¢ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ã«ã€ã‚³ãƒ³ãƒ†ãƒŠæŠ€è¡“ï¼ˆPodmanï¼‰ã¨ Linux ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ©Ÿèƒ½ï¼ˆmacvlan, VLAN, iptablesï¼‰ã‚’ä½¿ã£ã¦ã€æ“¬ä¼¼çš„ãªç‰©ç†ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹å®Ÿç¿’ã§ã™ã€‚

## ã‚´ãƒ¼ãƒ«

ä»¥ä¸‹ã®æ§‹æˆã‚’ **æ‰‹ã‚’å‹•ã‹ã—ã¦æ§‹ç¯‰ã—ã€ç†è§£** ã—ã¾ã™ã€‚

```mermaid
graph TD
    subgraph Host [Host Machine]
        eth0[Physical NIC: eth0]
        eth0 --- eth0.10[VLAN 10 Subinterface]
        eth0 --- eth0.20[VLAN 20 Subinterface]
    end

    subgraph "VLAN 10 Network (192.168.10.0/24)"
        ContainerA[Container A<br>192.168.10.10]
    end

    subgraph "VLAN 20 Network (192.168.20.0/24)"
        ContainerB[Container B<br>192.168.20.20]
    end

    subgraph RouterContainer [Router Container]
        eth10["eth0: 192.168.10.1<br>(Gateway for VLAN 10)"]
        eth20["eth1: 192.168.20.1<br>(Gateway for VLAN 20)"]
        ethNat[eth2: NAT -> Internet]
    end

    ContainerA -->|Default GW| eth10
    ContainerB -->|Default GW| eth20

    eth10 --- eth0.10
    eth20 --- eth0.20

    RouterContainer -->|NAT| eth0
```

**é”æˆã™ã‚‹çŠ¶æ…‹:**

1. **L2 åˆ†é›¢:** `Container A` ã¨ `Container B` ã¯ç•°ãªã‚‹ VLAN ã«å±ã—ã€ç›´æ¥é€šä¿¡ã§ãã¾ã›ã‚“ï¼ˆping ãŒé€šã‚‰ãªã„ï¼‰ã€‚
2. **L3 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:** `Router` ã‚³ãƒ³ãƒ†ãƒŠã‚’çµŒç”±ã™ã‚‹ã“ã¨ã§ã€ç›¸äº’ã«é€šä¿¡ã§ãã¾ã™ã€‚
3. **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶š:** `Router` ã® NAT æ©Ÿèƒ½ã«ã‚ˆã‚Šã€å„ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰å¤–éƒ¨ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼‰ã¸æ¥ç¶šã—ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ãŒå¯èƒ½ã§ã™ã€‚

---

## å‰ææ¡ä»¶

- **OS:** Ubuntu 24.04 LTS (æ¨å¥¨)
- **Podman:** Rootful ãƒ¢ãƒ¼ãƒ‰ (sudo æ¨©é™ãŒå¿…è¦)
- **ç‰©ç† NIC å:** `eth0`
  - â€» ç’°å¢ƒã«ã‚ˆã£ã¦ `ens5`, `ens3`, `enp0s3` ãªã©ç•°ãªã‚Šã¾ã™ã€‚`ip link` ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ã€é©å®œèª­ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚
- **ç’°å¢ƒåˆ¶ç´„:** macvlan/VLAN ãŒåˆ©ç”¨ã§ããªã„ã‚¯ãƒ©ã‚¦ãƒ‰VMã‚„ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ä»®æƒ³ç’°å¢ƒãŒã‚ã‚Šã¾ã™ã€‚å¯èƒ½ã§ã‚ã‚Œã°ãƒ–ãƒªãƒƒã‚¸æ¥ç¶šã® Linux VM ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

### ç’°å¢ƒç¢ºèª

```bash
# rootless ãŒ false ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
podman info | grep rootless
# rootless: false

# ç‰©ç†NICåã‚’ç¢ºèª
ip link show
```

---

## Step 1. ãƒ›ã‚¹ãƒˆã« VLAN ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œã‚‹

ã¾ãšã€ç‰©ç† NIC (`IF`) ã®ä¸Šã«ã€ä»®æƒ³çš„ãª VLAN ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚ŒãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã€Œç‰©ç†çš„ãªã€åˆ†é›¢ç·šã¨ãªã‚Šã¾ã™ã€‚

```bash
# ç‰©ç†ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹åã‚’ç¢ºèª (ä¾‹: ens5, eth0, enp0s3)
ip -brief link
export IF=ens5 # ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„

# VLAN ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (8021q) ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
sudo modprobe 8021q

# æ—¢å­˜ã®ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
sudo ip link delete $IF.10 2>/dev/null
sudo ip link delete $IF.20 2>/dev/null

# VLAN 10 ç”¨ã®ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ä½œæˆ
sudo ip link add link $IF name $IF.10 type vlan id 10

# VLAN 20 ç”¨ã®ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ä½œæˆ
sudo ip link add link $IF name $IF.20 type vlan id 20

# ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æœ‰åŠ¹åŒ–
sudo ip link set $IF.10 up
sudo ip link set $IF.20 up

# $IF.10, $IF.20 ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
ip link show
```

â€» `Cannot find device` ãªã©ã®ã‚¨ãƒ©ãƒ¼ã¯ã€ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

**è§£èª¬:**

- `macvlan` ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‰ãƒ©ã‚¤ãƒã¯ã€è¦ªã¨ãªã‚‹ç‰©ç†ï¼ˆã¾ãŸã¯ VLANï¼‰ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚
- ã“ã“ã§ã¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä»˜ä¸ã—ã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã¯ç´”ç²‹ã« L2 ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æµã™åœŸç®¡ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

---

## Step 2. Podman ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å®šç¾©ã™ã‚‹

ä½œæˆã—ãŸ VLAN ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ã€Podman ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®šç¾©ã‚’ä½œæˆã—ã¾ã™ã€‚

### VLAN 10 (Container A ç”¨)

```bash
sudo podman network create \
  --driver macvlan \
  --subnet 192.168.10.0/24 \
  --gateway 192.168.10.1 \
  -o parent=$IF.10 \
  net-vlan10
```

### VLAN 20 (Container B ç”¨)

```bash
sudo podman network create \
  --driver macvlan \
  --subnet 192.168.20.0/24 \
  --gateway 192.168.20.1 \
  -o parent=$IF.20 \
  net-vlan20
```

**ç¢ºèª:**

```bash
sudo podman network ls
# net-vlan10 ã¨ net-vlan20 ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
```

> **ğŸ“ Note: CIDR è¡¨è¨˜ (`/24`) ã¨ macvlan**
>
> **CIDR (Classless Inter-Domain Routing):**
> `/24` ã¯ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¯„å›²ã‚’è¡¨ã™è¨˜æ³•ã§ã™ã€‚IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ32ãƒ“ãƒƒãƒˆï¼‰ã®ã†ã¡ã€å…ˆé ­24ãƒ“ãƒƒãƒˆãŒã€Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä½æ‰€ï¼ˆè¡—ï¼‰ã€ã€æ®‹ã‚Šã®8ãƒ“ãƒƒãƒˆãŒã€Œå€‹ã€…ã®ãƒ›ã‚¹ãƒˆï¼ˆç•ªåœ°ï¼‰ã€ã‚’è¡¨ã—ã¾ã™ã€‚
> `/24` ã®å ´åˆã€ãƒ›ã‚¹ãƒˆéƒ¨ã¯ $2^8 = 256$ å€‹ã§ã™ãŒã€æœ€åˆï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã¨æœ€å¾Œï¼ˆãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã¯äºˆç´„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿéš›ã«ä½¿ãˆã‚‹ã®ã¯ **254å€‹** ã§ã™ã€‚
>
> - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: `192.168.10.0`
> - ãƒ›ã‚¹ãƒˆç¯„å›²: `192.168.10.1` ï½ `192.168.10.254`
>
> **macvlan:**
> Linuxã‚«ãƒ¼ãƒãƒ«ã®æ©Ÿèƒ½ã§ã€1ã¤ã®ç‰©ç†NICã«è¤‡æ•°ã®ç•°ãªã‚‹MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
> ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã¯ã€Œè‡ªåˆ†å°‚ç”¨ã®ç‰©ç†ã‚±ãƒ¼ãƒ–ãƒ«ãŒã‚¹ã‚¤ãƒƒãƒã«åˆºã•ã£ã¦ã„ã‚‹ã€ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€éå¸¸ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®å°‘ãªã„é«˜é€Ÿãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢ï¼ˆL2åˆ†é›¢ï¼‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---

## Step 3. ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’æ§‹ç¯‰ã™ã‚‹

ç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã‚’ã¤ãªãã€Œãƒ«ãƒ¼ã‚¿ãƒ¼ã€ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ 3 ã¤ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã¡ã¾ã™ã€‚

1. **eth0 (podman):** ãƒ›ã‚¹ãƒˆ/ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®å‡ºå£ (NATç”¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤)
2. **eth1 (net-vlan10):** VLAN 10 å´ã®ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ (192.168.10.1)
3. **eth2 (net-vlan20):** VLAN 20 å´ã®ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ (192.168.20.1)

```bash
# 1. ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ï¼ˆã¾ãš podman ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šï¼‰
# ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’å‘ãã¾ã™
sudo podman run -d --name router \
  --network podman \
  --cap-add NET_ADMIN \
  --sysctl net.ipv4.ip_forward=1 \
  alpine sleep infinity

# 2. net-vlan10 ã«æ¥ç¶š
sudo podman network connect \
  --ip 192.168.10.1 \
  net-vlan10 router

# 3. net-vlan20 ã«æ¥ç¶š
sudo podman network connect \
  --ip 192.168.20.1 \
  net-vlan20 router
```

**ç¢ºèª:**
ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ãŒ `eth0`, `eth1`, `eth2` ã® 3 ã¤ï¼ˆ+ `lo`ï¼‰å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
sudo podman exec router ip addr
```

å‡ºåŠ›ã« `10.88.x.x` (eth0), `192.168.10.1` (eth1), `192.168.20.1` (eth2) ã® IP ãŒè¦‹ãˆã‚Œã°æˆåŠŸã§ã™ã€‚

---

## Step 4. ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ NAT (IP ãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰) ã‚’è¨­å®šã™ã‚‹

ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ `iptables` ã‚’ä½¿ã„ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®é€šä¿¡ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ä¸­ç¶™ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã¯æ°¸ç¶šã§ã¯ãªãã€ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®å†èµ·å‹•ã§æ¶ˆãˆã¾ã™ã€‚æ°¸ç¶šåŒ–ã™ã‚‹å ´åˆã¯ã€`iptables-save` ã§ãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã« `iptables-restore` ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚„èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è‡ªå‹•å®Ÿè¡Œã™ã‚‹ï¼‰æ–¹æ³•ãŒä¸€èˆ¬çš„ã§ã™ã€‚é‹ç”¨ã§ã¯ã€ãƒ«ãƒ¼ãƒ«ã‚’å…¥ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ã€ã¾ãŸã¯ `nftables` ã®è¨­å®šã‚’ç”¨æ„ã—ã¦èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã‚€æ§‹æˆã‚‚ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚

```bash
# iptables ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo podman exec router apk add --no-cache iptables

# NAT è¨­å®šã‚’æŠ•å…¥
sudo podman exec router sh -c \
'\
# å¤–å‘ã (eth0) é€šä¿¡ã®é€ä¿¡å…ƒ IP ã‚’ eth0 ã® IP ã«æ›¸ãæ›ãˆã‚‹ (Masquerade)
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# è»¢é€è¨±å¯è¨­å®š
# VLAN 10 (eth1) -> Internet (eth0)
iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
# VLAN 20 (eth2) -> Internet (eth0)
iptables -A FORWARD -i eth2 -o eth0 -j ACCEPT
# æˆ»ã‚Šãƒ‘ã‚±ãƒƒãƒˆã®è¨±å¯ (Established/Related)
iptables -A FORWARD -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
'
```

**ã‚³ãƒãƒ³ãƒ‰è©³ç´°è§£èª¬:**

1. `iptables -t nat -A POSTROUTING -o eth2 -j MASQUERADE`
    - **æ„å‘³:** ã€Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå´ï¼ˆ`eth2`ï¼‰ã‹ã‚‰å‡ºã¦ã„ããƒ‘ã‚±ãƒƒãƒˆã®é€ä¿¡å…ƒIPã‚’ã€ãƒ«ãƒ¼ã‚¿ãƒ¼è‡ªèº«ã®IPã«æ›¸ãæ›ãˆã‚‹ã€
    - `-t nat`: ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›ã‚’è¡Œã† NAT ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    - `POSTROUTING`: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆè¡Œãå…ˆæ±ºå®šï¼‰ãŒçµ‚ã‚ã£ãŸã€Œå¾Œã€ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‡¦ç†ã—ã¾ã™ã€‚
    - `MASQUERADE`: å‹•çš„IPãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰ã‚’è¡Œã„ã¾ã™ï¼ˆNAPTï¼‰ã€‚

2. `iptables -A FORWARD -i eth0 -o eth2 -j ACCEPT`
    - **æ„å‘³:** ã€ŒVLAN 10 (`eth0`) ã‹ã‚‰å…¥ã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ (`eth2`) ã¸æŠœã‘ã‚‹ãƒ‘ã‚±ãƒƒãƒˆã‚’è¨±å¯ (`ACCEPT`) ã™ã‚‹ã€
    - `FORWARD`: ãƒ«ãƒ¼ã‚¿ãƒ¼è‡ªä½“å®›ã¦ã§ã¯ãªãã€ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ã€Œé€šéã€ã™ã‚‹ãƒ‘ã‚±ãƒƒãƒˆã‚’æ‰±ã†ãƒã‚§ãƒ¼ãƒ³ã§ã™ã€‚

3. `iptables -A FORWARD -i eth1 -o eth2 -j ACCEPT`
    - **æ„å‘³:** ã€ŒVLAN 20 (`eth1`) ã‹ã‚‰å…¥ã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ (`eth2`) ã¸æŠœã‘ã‚‹ãƒ‘ã‚±ãƒƒãƒˆã‚’è¨±å¯ã™ã‚‹ã€

4. `iptables -A FORWARD -i eth2 -m state --state ESTABLISHED,RELATED -j ACCEPT`
    - **æ„å‘³:** ã€Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ (`eth2`) ã‹ã‚‰æˆ»ã£ã¦ãã‚‹ãƒ‘ã‚±ãƒƒãƒˆã®ã†ã¡ã€ã“ã¡ã‚‰ã‹ã‚‰é–‹å§‹ã—ãŸé€šä¿¡ (`ESTABLISHED`) ã‚„ãã‚Œã«é–¢é€£ã™ã‚‹ã‚‚ã® (`RELATED`) ã ã‘ã‚’è¨±å¯ã™ã‚‹ã€
    - ã“ã‚ŒãŒãªã„ã¨ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å‡ºã›ã¦ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆWebã‚µã‚¤ãƒˆã®è¡¨ç¤ºçµæœãªã©ï¼‰ãŒãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦æˆ»ã£ã¦ãã¾ã›ã‚“ã€‚

> **ğŸ“ Note: NAT ã¨ IPãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰ï¼ˆNAPTï¼‰**
>
> **NAT (Network Address Translation):**
> IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›ã™ã‚‹æŠ€è¡“ã®ç·ç§°ã§ã™ã€‚é€šå¸¸ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ192.168.x.xï¼‰ã‚’æŒã¤æ©Ÿå™¨ã¯ã€ãã®ã¾ã¾ã§ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¨é€šä¿¡ã§ãã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã¸ã®çµŒè·¯ã‚’çŸ¥ã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚
>
> **IPãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰ (NAPT / IP Masquerade):**
> NATã®ä¸€ç¨®ã§ã€1ã¤ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã“ã“ã§ã¯ãƒ›ã‚¹ãƒˆå´ã®IPï¼‰ã‚’è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã§å…±æœ‰ã—ã¦å¤–éƒ¨ã¨é€šä¿¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚
> ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆã“ã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ã¯ã€å†…å´ã‹ã‚‰ã®é€šä¿¡ã®ã€Œé€ä¿¡å…ƒIPã€ã¨ã€Œé€ä¿¡å…ƒãƒãƒ¼ãƒˆã€ã‚’ã€è‡ªåˆ†ã®ã€Œå¤–å´ã®IPã€ã¨ã€Œç©ºã„ã¦ã„ã‚‹ãƒãƒ¼ãƒˆã€ã«æ›¸ãæ›ãˆã€å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã—ã¦å¤–éƒ¨ã¸é€ä¿¡ã—ã¾ã™ã€‚æˆ»ã£ã¦ããŸãƒ‘ã‚±ãƒƒãƒˆã¯ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã—ã¦ã€å…ƒã®ã‚³ãƒ³ãƒ†ãƒŠã¸è»¢é€ã•ã‚Œã¾ã™ã€‚
> ã“ã‚Œã«ã‚ˆã‚Šã€å¤–éƒ¨ã‹ã‚‰ã¯ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆ1ã¤ã®IPï¼‰ã ã‘ãŒé€šä¿¡ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚ã€Œãƒã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰ï¼ˆä»®é¢èˆè¸ä¼šï¼‰ã€ã¨å‘¼ã°ã‚Œã‚‹æ‰€ä»¥ã§ã™ã€‚

---

## Step 5. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã™ã‚‹

VLAN 10 ã¨ VLAN 20 ã«ãã‚Œãã‚Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’é…ç½®ã—ã¾ã™ã€‚

### Container A (VLAN 10)

```bash
sudo podman run -d --name a \
  --network net-vlan10 \
  --ip 192.168.10.10 \
  alpine sleep infinity
```

**ç¢ºèª:**

```bash
# 1. IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ­£ã—ãå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‹
sudo podman exec a ip addr show eth0

# 2. ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆrouterï¼‰ã« Ping ãŒå±Šãã‹
sudo podman exec a ping -c 3 192.168.10.1
```

### Container B (VLAN 20)

```bash
sudo podman run -d --name b \
  --network net-vlan20 \
  --ip 192.168.20.20 \
  alpine sleep infinity
```

**ç¢ºèª:**

```bash
# 1. IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèª
sudo podman exec b ip addr show eth0

# 2. ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆrouterï¼‰ã« Ping ãŒå±Šãã‹
sudo podman exec b ping -c 3 192.168.20.1
```

---

## Step 6. å‹•ä½œç¢ºèª

æ§‹ç¯‰ã—ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒæœŸå¾…é€šã‚Šå‹•ä½œã™ã‚‹ã‹æ¤œè¨¼ã—ã¾ã™ã€‚

### 1. ç–é€šç¢ºèª (Routing)

Container A ã‹ã‚‰ Container B (ç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯) ã¸ Ping ã‚’æ‰“ã¡ã¾ã™ã€‚
ãƒ«ãƒ¼ã‚¿ãƒ¼ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚Œã°ã€Ping ã¯é€šã‚Šã¾ã™ã€‚

```bash
sudo podman exec a ping -c 3 192.168.20.20
# PING 192.168.20.20 (192.168.20.20): 56 data bytes
# 64 bytes from 192.168.20.20: seq=0 ttl=63 time=0.xxx ms
# ...
```

é€†æ–¹å‘ (B -> A) ã‚‚ç¢ºèªã—ã¾ã™ã€‚

```bash
sudo podman exec b ping -c 3 192.168.10.10
```

### 2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šç¢ºèª (NAT)

Container A ã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```bash
# curl ã¨ dig (bind-tools) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã‚‹ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ï¼‰
sudo podman exec a apk add --no-cache curl bind-tools

# DNS ã®ç¢ºèª
sudo podman exec a dig www.google.com

# HTTP ã®ç¢ºèª
sudo podman exec a curl -I https://www.google.com
# HTTP/2 200 ... ãªã©ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚Œã°OK
```

### 3. å®Ÿé¨“ï¼šãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’é®æ–­ã—ã¦ã¿ã‚‹

ãƒ«ãƒ¼ã‚¿ãƒ¼ã® `FORWARD` ãƒã‚§ãƒ¼ãƒ³ã«ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦ã€VLAN 10 (`eth1`) ã‹ã‚‰ VLAN 20 (`eth2`) ã¸ã®é€šä¿¡ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
# 1. é®æ–­ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ï¼ˆå…ˆé ­ã«æŒ¿å…¥ï¼‰
# "eth1 ã‹ã‚‰å…¥ã£ã¦ eth2 ã¸å‡ºã‚‹ãƒ‘ã‚±ãƒƒãƒˆã‚’ç ´æ£„ (DROP) ã™ã‚‹"
sudo podman exec router iptables -I FORWARD -i eth1 -o eth2 -j DROP

# 2. ç–é€šç¢ºèªï¼ˆå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
# Container A -> Container B
sudo podman exec a ping -c 3 -W 1 192.168.20.20
# çµæœ: ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ 100% ã«ãªã‚‹ã¯ãšã§ã™

# 3. ãƒ«ãƒ¼ãƒ«ã®å‰Šé™¤ï¼ˆå¾©æ—§ï¼‰
# è¿½åŠ ã—ãŸãƒ«ãƒ¼ãƒ« (-D) ã‚’å‰Šé™¤
sudo podman exec router iptables -D FORWARD -i eth1 -o eth2 -j DROP

# 4. ç–é€šç¢ºèªï¼ˆæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
sudo podman exec a ping -c 3 192.168.20.20
```

---

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

å®Ÿç¿’ãŒçµ‚ã‚ã£ãŸã‚‰ã€ç’°å¢ƒã‚’ãã‚Œã„ã«æˆ»ã—ã¾ã—ã‚‡ã†ã€‚

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢ã¨å‰Šé™¤
sudo podman rm -f a b router

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å‰Šé™¤
sudo podman network rm net-vlan10 net-vlan20

# ãƒ›ã‚¹ãƒˆä¸Šã® VLAN ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹å‰Šé™¤
sudo ip link delete $IF.10
sudo ip link delete $IF.20
```

---

## ã¾ã¨ã‚

1. **macvlan** ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ç‰©ç†ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆL2ï¼‰ã«ç›´æ¥æ¥ç¶šã—ãŸã‚ˆã†ã«è¦‹ã›ã‚‹æŠ€è¡“ã§ã™ã€‚
2. **VLAN** ã‚µãƒ–ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã†ã“ã¨ã§ã€1æœ¬ã®ç‰©ç†ã‚±ãƒ¼ãƒ–ãƒ«ä¸Šã§è«–ç†çš„ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’åˆ†é›¢ã§ãã¾ã™ã€‚
3. **Linux ã‚³ãƒ³ãƒ†ãƒŠ** ã¯ã€é©åˆ‡ãªè¨­å®šï¼ˆ`ip_forward`, `iptables`ï¼‰ã‚’è¡Œãˆã°ã€ç°¡å˜ã«é«˜æ€§èƒ½ãªãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
